<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Creates an index on the given field(s), or does nothing if the index 
   already exists</title>

 </head>
 <body><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mongocollection.drop.html">MongoCollection::drop</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mongocollection.find.html">MongoCollection::find</a></div>
 <div class="up"><a href="class.mongocollection.html">MongoCollection</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="mongocollection.ensureindex" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">MongoCollection::ensureIndex</h1>
  <p class="verinfo">(PECL mongo &gt;=0.9.0)</p><p class="refpurpose"><span class="refname">MongoCollection::ensureIndex</span> &mdash; <span class="dc-title">
   Creates an index on the given field(s), or does nothing if the index 
   already exists
  </span></p>

 </div>

 <div class="refsect1 description" id="refsect1-mongocollection.ensureindex-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">bool</span> <span class="methodname"><b>MongoCollection::ensureIndex</b></span>
    ( <span class="methodparam"><span class="type">array</span> <tt class="parameter">$keys</tt></span>
   [, <span class="methodparam"><span class="type">array</span> <tt class="parameter">$options</tt><span class="initializer"> = array()</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   A unique index cannot be created on a field if multiple existing documents do
   not contain the field.  The field is effectively <b><tt>NULL</tt></b> for these documents 
   and thus already non-unique.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-mongocollection.ensureindex-parameters"> 
  <h3 class="title">Parameters</h3> 
  <p class="para">
   <dl>

    <dt>

     <span class="term">
      <i><tt class="parameter">keys</tt></i>
     </span>
     <dd>

      <p class="para">
       Field or fields to use as index.
      </p>
     </dd>

    </dt>
   
    <dt>

     <span class="term">
      <i><tt class="parameter">options</tt></i>
     </span>
     <dd>

      <p class="para">
       This parameter is an associative array of the form 
       <i>array(&quot;optionname&quot; =&gt; &lt;boolean&gt;, ...)</i>. Currently 
       supported options are: 
       <ul class="itemizedlist">
        <li class="listitem">
         <p class="para">
          <i>&quot;unique&quot;</i>
         </p>
         <p class="para">
          Create a unique index.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <i>&quot;dropDups&quot;</i>
         </p>
         <p class="para">
          If a unique index is being created and duplicate values exist, drop
          all but one duplicate value.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <i>&quot;background&quot;</i>
         </p>
         <p class="para">
          If you are using MongoDB version 1.3.2+, you can create indexes in the
          background while other operations are taking place.  By default, index
          creation happens synchronously.  If you specify <b><tt>TRUE</tt></b> with this 
          option, index creation will be asynchronous.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <i>&quot;safe&quot;</i>
         </p>
         <p class="para">
          Starting with driver version 1.0.4, you can specify a boolean value 
          for checking if the index creation succeeded.  The driver will throw
          a MongoCursorException if index creation failed.
         </p>
         <p class="para">
          If you are using replication and the master has changed, using &quot;safe&quot; 
          will make the driver disconnect from the master, throw and exception, 
          and attempt to find a new master on the next operation (your 
          application must decide whether or not to retry the operation on the
          new master). 
         </p>
         <p class="para">
          If you <em class="emphasis">do not</em> use &quot;safe&quot; with a replica set and 
          the master changes, there will be no way for the driver to know about 
          the change so it will continuously and silently fail to write.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <i>&quot;name&quot;</i>
         </p>
         <p class="para">
          After driver version 1.0.4 (NOT including 1.0.4) you can specify an
          index name.  This can be useful if you are indexing many keys and 
          Mongo complains about the index name being too long.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <i>&quot;timeout&quot;</i>
         </p>
         <p class="para">
          Integer, defaults to <i>MongoCursor::$timeout</i>.  If 
          &quot;safe&quot; is set, this sets how long (in milliseconds) for the client to
          wait for a database response.  If the database does not respond within
          the timeout period, a <a href="class.mongocursortimeoutexception.html" class="classname">MongoCursorTimeoutException</a>
          will be thrown.
         </p>
        </li>
       </ul>
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-mongocollection.ensureindex-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns <b><tt>TRUE</tt></b>.
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-mongocollection.ensureindex-changelog">
  <h3 class="title">Changelog</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead valign="middle">
      <tr valign="middle">
       <th>Version</th>
       <th>Description</th>
      </tr>

     </thead>

     <tbody valign="middle" class="tbody">
      <tr valign="middle">
       <td align="left">1.2.0</td>
       <td align="left">
        Added timeout option.
       </td>
      </tr>

      <tr valign="middle">
       <td align="left">1.0.11</td>
       <td align="left">
        &quot;safe&quot; will trigger master failover, if necessary.
       </td>
      </tr>

      <tr valign="middle">
       <td align="left">1.0.11</td>
       <td align="left">
        <a href="class.mongoexception.html" class="classname">MongoException</a> will be thrown if index name
        (either generated or set) is longer than 128 bytes.
       </td>
      </tr>

      <tr valign="middle">
       <td align="left">1.0.2</td>
       <td align="left">
        Changed &quot;options&quot; parameter from boolean to array.  Pre-1.0.2, the
        second parameter was an optional boolean value specifying a unique 
        index.
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-mongocollection.ensureindex-errors">
  <h3 class="title">Errors/Exceptions</h3>
  <p class="para">
   Throws <a href="class.mongoexception.html" class="classname">MongoException</a> if the index name is longer than
   128 bytes. (Version 1.0.11+)
  </p>
  <p class="para">
   Throws <a href="class.mongocursorexception.html" class="classname">MongoCursorException</a> if the &quot;safe&quot; option is 
   set and the index creation fails.
  </p>
  <p class="para">
   Throws <a href="class.mongocursortimeoutexception.html" class="classname">MongoCursorTimeoutException</a> if the &quot;safe&quot; 
   option is set and the operation takes longer than 
   <var class="varname"><var class="varname">MongoCursor::$timeout</var></var> milliseconds to complete.  This does
   not kill the operation on the server, it is a client-side timeout.
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-mongocollection.ensureindex-examples">
  <h3 class="title">Examples</h3>
  <div class="example" id="example-1389">
   <p><b>Example #1 <span class="function"><b>MongoCollection::ensureIndex()</b></span> example</b></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$c&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoCollection</span><span style="color: #007700">(</span><span style="color: #0000BB">$db</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'foo'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;create&nbsp;an&nbsp;index&nbsp;on&nbsp;'x'&nbsp;ascending<br /></span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ensureIndex</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'x'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">//&nbsp;create&nbsp;an&nbsp;index&nbsp;on&nbsp;'z'&nbsp;ascending&nbsp;and&nbsp;'zz'&nbsp;descending<br /></span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ensureIndex</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'z'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'zz'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;-</span><span style="color: #0000BB">1</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">//&nbsp;create&nbsp;a&nbsp;unique&nbsp;index&nbsp;on&nbsp;'x'<br /></span><span style="color: #0000BB">$c</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ensureIndex</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'x'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">),&nbsp;array(</span><span style="color: #DD0000">"unique"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
  <div class="example" id="example-1390">
   <p><b>Example #2 Drop duplicates example</b></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"username"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"joeschmoe"</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"username"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"joeschmoe"</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">/*<br />&nbsp;*&nbsp;index&nbsp;creation&nbsp;fails,&nbsp;you&nbsp;can't&nbsp;create&nbsp;a&nbsp;unique&nbsp;index&nbsp;on&nbsp;a&nbsp;key&nbsp;with&nbsp;<br />&nbsp;*&nbsp;non-unique&nbsp;values<br />&nbsp;*/<br /></span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ensureIndex</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"username"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">),&nbsp;array(</span><span style="color: #DD0000">"unique"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">/*<br />&nbsp;*&nbsp;index&nbsp;creation&nbsp;succeeds:&nbsp;one&nbsp;of&nbsp;the&nbsp;documents&nbsp;is&nbsp;removed&nbsp;from&nbsp;the&nbsp;collection<br />&nbsp;*/<br /></span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ensureIndex</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"username"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">),&nbsp;array(</span><span style="color: #DD0000">"unique"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"dropDups"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">/*&nbsp;<br />&nbsp;*&nbsp;now&nbsp;we&nbsp;have&nbsp;a&nbsp;unique&nbsp;index,&nbsp;more&nbsp;inserts&nbsp;with&nbsp;the&nbsp;same&nbsp;username&nbsp;(such&nbsp;as&nbsp;the<br />&nbsp;*&nbsp;one&nbsp;below)&nbsp;will&nbsp;fail<br />&nbsp;*/<br /></span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"username"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"joeschmoe"</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>

  <div class="example" id="example-1391">
   <p><b>Example #3 Geospatial Indexing</b></p>
   <div class="example-contents"><p>
    Mongo supports geospatial indexes, which allow you to search for documents
    near a given location or within a shape.  For example, to create a 
    geospatial index on the &quot;loc&quot; field:
   </p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">ensureIndex</span><span style="color: #007700">(array(</span><span style="color: #DD0000">"loc"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"2d"</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 </div>


 <div class="refsect1 seealso" id="refsect1-mongocollection.ensureindex-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   MongoDB core docs on 
   <a href="http://dochub.mongodb.org/core/indexes" class="link external">&raquo;&nbsp;vanilla indexes</a> and 
   <a href="http://dochub.mongodb.org/core/geo" class="link external">&raquo;&nbsp;geospatial indexes</a>.
  </p>
 </div>


</div><hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mongocollection.drop.html">MongoCollection::drop</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mongocollection.find.html">MongoCollection::find</a></div>
 <div class="up"><a href="class.mongocollection.html">MongoCollection</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
